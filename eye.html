<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detector Kantuk - hallo king zezy</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1724;
      --accent:#4ee1a1;
      --danger:#ff5252;
      --muted:#9aa7c7;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6eef8;background:linear-gradient(180deg,#071025 0%, #0b1628 100%);}
    .wrap{max-width:920px;margin:28px auto;padding:18px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6);}
    h1{margin:0 0 8px;font-size:20px;color:var(--accent)}
    p.desc{margin:0 0 18px;color:var(--muted)}
    .stage{position:relative;display:flex;gap:16px;align-items:flex-start}
    video#input_video{width:560px;height:420px;background:#000;border-radius:8px;object-fit:cover;}
    canvas#overlay{position:absolute;left:0;top:0;pointer-events:none;border-radius:8px;}
    .panel{flex:1;min-width:260px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;color:#cfe6ff}
    .indicator{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .dot{width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(78,225,161,0.12)}
    .status{font-weight:600}
    .small{font-size:13px;color:var(--muted);margin-top:6px}
    .progressWrap{height:12px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;margin-top:10px}
    .progress{height:100%;width:0%;background:linear-gradient(90deg,var(--danger),#ff8a80);transition:width 0.12s linear}
    .metrics{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .metric{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;font-size:13px;color:var(--muted);min-width:110px}
    .btns{display:flex;gap:8px;margin-top:12px}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:8px 10px;border-radius:8px;cursor:pointer}
    button.secondary{color:var(--muted)}
    footer{margin-top:14px;font-size:12px;color:var(--muted)}
    @media(max-width:900px){
      .stage{flex-direction:column;align-items:center}
      video#input_video{width:320px;height:240px}
      canvas#overlay{width:320px;height:240px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Detector Kantuk (Webcam) — hallo king zezy</h1>
    <p class="desc">Halaman ini buka kamera, deteksi landmark wajah, hitung indikator mata (EAR). Kalau mata tertutup lama → alert.</p>
    <div class="stage">
      <div style="position:relative">
        <video id="input_video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="panel">
        <div class="indicator">
          <div id="dot" class="dot"></div>
          <div>
            <div class="status" id="statusText">Status: Menunggu</div>
            <div class="small" id="advice">Izin kamera belum diberikan atau belum terdeteksi.</div>
          </div>
        </div>

        <div class="metrics">
          <div class="metric">EAR: <span id="earVal">-</span></div>
          <div class="metric">Frames tertutup: <span id="closedFrames">0</span></div>
          <div class="metric">Waktu tertutup (ms): <span id="closedMillis">0</span></div>
        </div>

        <div class="progressWrap" title="Progress waktu mata tertutup">
          <div id="progressBar" class="progress"></div>
        </div>

        <div class="btns">
          <button id="btnStart">Start Kamera</button>
          <button id="btnStop" class="secondary">Stop Kamera</button>
          <button id="btnReset" class="secondary">Reset Alert</button>
        </div>

        <footer>
          Tips: Buka halaman via HTTPS atau localhost. Izinkan akses kamera. Jika false alert, atur threshold di kode.
        </footer>
      </div>
    </div>
  </div>

  <!-- MediaPipe dependencies (camera_utils, drawing_utils, face_mesh) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

  <script>
    // Nama: Detector Kantuk sederhana menggunakan MediaPipe FaceMesh
    // Author: untuk king zezy — copy paste dan langsung jalan (butuh HTTPS atau localhost)
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('overlay');
    const canvasCtx = canvasElement.getContext('2d');
    const dot = document.getElementById('dot');
    const statusText = document.getElementById('statusText');
    const advice = document.getElementById('advice');
    const earValEl = document.getElementById('earVal');
    const closedFramesEl = document.getElementById('closedFrames');
    const closedMillisEl = document.getElementById('closedMillis');
    const progressBar = document.getElementById('progressBar');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnReset = document.getElementById('btnReset');

    // --- PARAMETER (bisa di-tweak) ---
    const EAR_THRESHOLD = 0.27; // ambang eye aspect ratio -> dianggap mata tertutup jika < threshold
    const CLOSED_TIME_THRESHOLD_MS = 1500; // waktu (ms) mata tertutup terus-menerus untuk memicu alert
    const SMOOTHING_ALPHA = 0.85; // smoothing untuk EAR agar tidak fluktuatif
    // -------------------------------

    let camera = null;
    let lastTimeEyesOpen = null;
    let closedStartTime = null;
    let isAlerted = false;
    let smoothedEAR = null;
    let closedFramesCount = 0;

    // Indices landmark MediaPipe untuk menghitung EAR (umum dipakai)
    const LEFT_EYE = [33, 160, 158, 133, 153, 144];
    const RIGHT_EYE = [263, 387, 385, 362, 380, 373];

    function dist(a,b){
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      return Math.hypot(dx, dy);
    }

    // EAR formula: (||p2-p6|| + ||p3-p5||) / (2 * ||p1-p4||)
    function computeEAR(landmarks, eyeIdx){
      const p1 = landmarks[eyeIdx[0]];
      const p2 = landmarks[eyeIdx[1]];
      const p3 = landmarks[eyeIdx[2]];
      const p4 = landmarks[eyeIdx[3]];
      const p5 = landmarks[eyeIdx[4]];
      const p6 = landmarks[eyeIdx[5]];
      const vertical1 = dist(p2,p6);
      const vertical2 = dist(p3,p5);
      const horizontal = dist(p1,p4);
      if (horizontal === 0) return 0;
      return (vertical1 + vertical2) / (2.0 * horizontal);
    }

    function updateUI(isEyesClosed, ear, closedMs){
      // dot & status
      if (isEyesClosed) {
        dot.style.background = 'var(--danger)';
        dot.style.boxShadow = '0 0 14px rgba(255,82,82,0.18)';
        statusText.textContent = 'Status: Mata Tertutup';
        advice.textContent = isAlerted ? 'Alert terkirim: segera istirahat.' : 'Mata tertutup terdeteksi — waspada.';
      } else {
        dot.style.background = 'var(--accent)';
        dot.style.boxShadow = '0 0 12px rgba(78,225,161,0.12)';
        statusText.textContent = 'Status: Mata Terbuka';
        advice.textContent = 'OK — tetap fokus, beristirahat kalau lelah.';
      }

      earValEl.textContent = ear.toFixed(3);
      closedFramesEl.textContent = closedFramesCount;
      closedMillisEl.textContent = Math.round(closedMs);

      // progress bar (saturate 0-100%)
      const pct = Math.min(1, closedMs / CLOSED_TIME_THRESHOLD_MS) * 100;
      progressBar.style.width = pct + '%';
    }

    // fungsi yang dipanggil setiap kali ada hasil FaceMesh
    function onResults(results){
      // draw video frame
      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;
      canvasCtx.save();
      canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height);
      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        for (const landmarks of results.multiFaceLandmarks) {
          // gambar landmark wajah tipis
          window.drawConnectors(canvasCtx, landmarks, window.FaceMesh.FACEMESH_TESSELATION, {color: '#8899b3', lineWidth: 0.6});
          window.drawConnectors(canvasCtx, landmarks, window.FaceMesh.FACEMESH_RIGHT_EYE, {color: '#a3d8ff', lineWidth: 1.2});
          window.drawConnectors(canvasCtx, landmarks, window.FaceMesh.FACEMESH_LEFT_EYE, {color: '#a3d8ff', lineWidth: 1.2});
        }

        // ambil face pertama
        const lm = results.multiFaceLandmarks[0];

        // compute EAR rata-rata kedua mata
        const leftEAR = computeEAR(lm, LEFT_EYE);
        const rightEAR = computeEAR(lm, RIGHT_EYE);
        let ear = (leftEAR + rightEAR) / 2;

        // smoothing
        if (smoothedEAR === null) smoothedEAR = ear;
        smoothedEAR = SMOOTHING_ALPHA * smoothedEAR + (1 - SMOOTHING_ALPHA) * ear;

        // put pixel coords helper (optional draw circles)
        // convert normalized to screen coords for small markers
        const w = videoElement.videoWidth;
        const h = videoElement.videoHeight;

        // draw small circles on eye landmarks (optional)
        const eyeColor = smoothedEAR < EAR_THRESHOLD ? '#ff8a80' : '#4ee1a1';
        for (const idx of LEFT_EYE.concat(RIGHT_EYE)) {
          const pt = lm[idx];
          canvasCtx.beginPath();
          canvasCtx.fillStyle = eyeColor;
          canvasCtx.arc(pt.x * w, pt.y * h, 2.2, 0, Math.PI*2);
          canvasCtx.fill();
        }

        // determine closed / open
        const now = performance.now();
        let closedMs = 0;
        let isClosed = smoothedEAR < EAR_THRESHOLD;

        if (isClosed) {
          if (!closedStartTime) closedStartTime = now;
          closedMs = now - closedStartTime;
          closedFramesCount += 1;
        } else {
          closedStartTime = null;
          closedFramesCount = 0;
          lastTimeEyesOpen = now;
        }

        // update UI
        updateUI(isClosed, smoothedEAR, closedMs);

        // alert trigger: jika waktu tertutup melebihi ambang dan belum di-alert
        if (isClosed && closedMs >= CLOSED_TIME_THRESHOLD_MS && !isAlerted) {
          isAlerted = true;
          // visual + suara + alert
          try {
            // text-to-speech
            const msg = new SpeechSynthesisUtterance('Anda mengantuk, segera istirahat');
            msg.lang = 'id-ID';
            window.speechSynthesis.speak(msg);
          } catch(e){}
          setTimeout(()=> {
            alert('Anda mengantuk — segera istirahat.');
          }, 150);
        }

      } else {
        // tidak terdeteksi wajah
        smoothedEAR = null;
        closedStartTime = null;
        closedFramesCount = 0;
        updateUI(false, 0, 0);
        canvasCtx.font = '14px Inter';
        canvasCtx.fillStyle = '#c2d7ff';
        canvasCtx.fillText('Wajah tidak terdeteksi', 10, 20);
      }

      canvasCtx.restore();
    }

    // init MediaPipe FaceMesh
    const faceMesh = new FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });
    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });
    faceMesh.onResults(onResults);

    // camera helper dari mediapipe
    async function startCamera() {
      // ket: Camera util akan memanggil faceMesh.send({image: videoElement})
      if (camera) return;
      try {
        // Ensure video constraints
        camera = new Camera(videoElement, {
          onFrame: async () => {
            await faceMesh.send({image: videoElement});
          },
          width: 640,
          height: 480
        });
        camera.start();
        statusText.textContent = 'Status: Menjalankan Kamera';
        advice.textContent = 'Mendeteksi...';
      } catch (err) {
        console.error('startCamera error', err);
        statusText.textContent = 'Status: Error akses kamera';
        advice.textContent = 'Pastikan izinkan kamera dan buka via HTTPS/localhost.';
      }
    }

    function stopCamera(){
      if (camera) {
        try { camera.stop(); } catch(e){}
        camera = null;
      }
      if (videoElement.srcObject) {
        // stop all tracks
        const tracks = videoElement.srcObject.getTracks();
        tracks.forEach(t=>t.stop());
        videoElement.srcObject = null;
      }
      statusText.textContent = 'Status: Kamera berhenti';
      advice.textContent = 'Tekan "Start Kamera" untuk mulai lagi.';
      dot.style.background = 'var(--accent)';
      isAlerted = false;
      smoothedEAR = null;
      closedStartTime = null;
      closedFramesCount = 0;
      updateUI(false, 0, 0);
    }

    btnStart.addEventListener('click', async () => {
      // start kamera (jika page belum memberikan permission, browser akan minta)
      await startCamera();
    });

    btnStop.addEventListener('click', () => {
      stopCamera();
    });

    btnReset.addEventListener('click', () => {
      isAlerted = false;
      closedStartTime = null;
      closedFramesCount = 0;
      smoothedEAR = null;
      progressBar.style.width = '0%';
      alert('Alert direset.');
    });

    // start otomatis optional (comment out if tidak mau auto)
    // startCamera();

    // catatan: getUserMedia membutuhkan HTTPS atau file:// pada beberapa browser
  </script>
</body>
</html>
